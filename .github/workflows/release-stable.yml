name: Release Stable

on:
  push:
    branches: [main]

concurrency:
  group: release-stable-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release:
    if: github.repository == 'cbassuarez/flux' && !startsWith(github.event.head_commit.message, 'chore(release):')
    runs-on: ubuntu-latest
    env:
      GIT_PAGER: cat
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.1
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Check dist freshness (self-heal + tiny logs)
        id: dist
        shell: bash
        run: |
          set -euo pipefail
          export GIT_PAGER=cat
          git config --global core.pager cat

          # Make globs safe: if packages/*/dist doesn't match, it disappears.
          shopt -s nullglob

          # Use real directories (shell-expanded), not git glob-magic.
          DIST_DIRS=(packages/*/dist packages/viewer/editor-dist)

          if [ ${#DIST_DIRS[@]} -eq 0 ]; then
            echo "::warning::No dist directories found; skipping dist sync."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGED="$(git status --porcelain=v1 --untracked-files=all -- "${DIST_DIRS[@]}")"
          if [ -n "$CHANGED" ]; then
            echo "dist changes detected; stagingâ€¦"
            echo "$CHANGED" | head -n 80
            echo "...(truncated)"
            git add -A -- "${DIST_DIRS[@]}"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Compile release scripts
        run: pnpm -w exec tsc -p scripts/release/tsconfig.json

      - name: Bump patch + sync versions
        run: node scripts/release/dist/bumpPatchAndSync.js

      - name: Commit release (includes dist fixes)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(node -e "const v=require('./version.json'); console.log(v.version ?? v.baseVersion);")"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Commit version + workspace package versions + any dist artifacts staged earlier.
          git add -A -- version.json packages/*/package.json packages/*/dist packages/viewer/editor-dist

          # If nothing changed (rare but possible), exit cleanly.
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore(release): v${VERSION}"
          git tag -a "v${VERSION}" -m "v${VERSION}"

      - name: Push release commit and tag
        run: git push origin HEAD --tags
